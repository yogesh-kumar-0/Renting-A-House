<% layout('layout/boilerplate.ejs') -%>
<script> const mapboxToken = '<%=process.env.MAP_BOX_TOKEN%>';
const listing = <%- JSON.stringify(listing) %>;

</script>
<body>
    <div class="row">
        <div class="col-10 offset-2 mt-3 ">
            <h2 class=" mb-4 heading "><b><%= listing.title %></b> </h2>
            <div class="card col-8 ">
                <img class="card-img-top show-img" style="height: 50vh; "
                    src="<%= listing.image  %>" alt="listing image" />
                <div class="card-body">
                    <p class="card-text"><strong>Owner:</strong> <i><%=
                            listing.owner ? listing.owner.username : 'Anonymous'
                            %></i></p>

                    <ul>

                        <li><%= listing.description %></li>
                        <li><i class="fa-solid fa-indian-rupee-sign"></i><%=
                            listing.price.toLocaleString('en-IN') %></li>
                        <li><%= listing.location %></li>
                        <li><%= listing.country %></li>
                        <!-- <li><%= //listing.title  %></li> -->
                    </ul>

                </div>
            </div>

            <br>
            <% if(currUser && currUser._id.equals(listing.owner._id)) {%>
            <div class="btns">
                <a class="btn  mb-4  btncol"
                    href="/listings/<%=  listing._id %>/edit">Edit </a>

                <form method="post"
                    action="/listing/<%= listing._id %>/delete?_method=delete">
                    <button class="btn btn-dark ms-5 col-10 "
                        type="submit">Delete</button>

                </form>
            </div>
            <% } %>
            <hr>

            <% if(currUser && !currUser._id.equals(listing.owner._id)){ %>
            <div>
                <h2> Leave a Review</h2>
                <form method="post" action="/listing/<%=  listing._id %>/review"
                    novalidate class="needs-validation">
                    <div class="fs-3" >
                        
                            
                         <fieldset class="starability-slot">
                                <legend><strong>Rate this</strong></legend>
                                <input type="radio" id="no-rate" class="input-no-rate" name="review[rating]" value="0" checked aria-label="No rating." />
                                <input type="radio" id="second-rate1" name="review[rating]" value="1" />
                                <label for="second-rate1" title="Terrible">1 star</label>
                                <input type="radio" id="second-rate2" name="review[rating]" value="2" />
                                <label for="second-rate2" title="Not good">2 stars</label>
                                <input type="radio" id="second-rate3" name="review[rating]" value="3" />
                                <label for="second-rate3" title="Average">3 stars</label>
                                <input type="radio" id="second-rate4" name="review[rating]" value="4" />
                                <label for="second-rate4" title="Very good">4 stars</label>
                                <input type="radio" id="second-rate5" name="review[rating]" value="5" />
                                <label for="second-rate5" title="Amazing">5 stars</label>
                        </fieldset>



                            </div>
                            <br>
                    <div>
                        <label for="comment" class="form-label"><h5><strong>Comment</strong></h5></label>
                        <textarea class="form-control" id="comment"
                            name="review[comment]" rows='5'
                            placeholder="Write your review here..."
                            required></textarea>
                        <div class="invalid-feedback">
                            Please provide a valid comment.
                        </div>
                    </div>
                </div>
                <button class="btn btncol my-3" type="submit">Submit
                    Review</button>
            </form>
            <% } %>
        </div>

        <div class=" offset-2 ">
            <h4 class="mt-5">Reviews:</h4>
            <div class="row mb-5">
                <% if(listing.reviews.length > 0) { %>

                <% listing.reviews.forEach(review => { %>
                <div class="card col-4 mb-3 ms-3"
                    style="border: 2px solid black;">
                    <div class="card-body">
                       
                        <h5 class="card-title"><strong>Reviewer:</strong> <%=
                            review.author.username %></h5>
                             <p class="starability-result" data-rating="<%= review.rating %>">
                                 Rated: <%= review.rating %> stars
                                </p>
                            
                              
                        
                                
                
                        <h5 class="card-text"><strong> <%=
                            review.comment %></strong></h5>
                        <% if(currUser &&
                        currUser._id.equals(review.author._id)) { %>
                        <form method="post"
                            action="/listing/<%= listing._id %>/review/<%= review._id %>?_method=delete">
                            <button class="btn btncol "> Delete</button>
                        </form>
                        <% } %>

                    </div>

                    <button class="btn btn-dark mb-2" type="button">
                        View Details</button>

                </div>
                <% }) %>

                <% } else { %>
                <p>No reviews yet.</p>
                <% } %>
            </div>
        <div class="col-6 offset-1 mb-3">
            <h3>where you'll be</h3>
            <div id="map">

                </div> </div>
        </div>
    </div>


   <script src="/js/mapbox.js"></script>

</body>
